--'Faridabad','Gurgaon','New Delhi','Noida'

WITH ExcludedCustomers AS (
    SELECT  [Identified Customers]
    FROM eppl.dbo.eppl_merge
    WHERE date >='2025-01-01'
	and Category='Spa Services'
	 and [Bill from City] in ('Faridabad','Gurgaon','New Delhi','Noida')
      AND [Parent Channel] IN ('Retail') group by [Identified Customers]
)
SELECT  A.[Identified Customers],A.[Customer's Name],sum(sales) as sales
FROM eppl.dbo.eppl_merge A
left join ExcludedCustomers ec on ec.[Identified Customers] = A.[Identified Customers]
WHERE date >='2025-01-01'
  AND [Customer Type] = 'Customer Sales'
  AND [Parent Channel] = 'Retail'
  AND A.[Identified Customers] != 'NA'
  AND [Customer's Name] NOT LIKE '%default%'
  and Category != 'Spa Services'
 and [Bill from City] in ('Faridabad','Gurgaon','New Delhi','Noida')
  and ec.[Identified Customers] is null
  group by A.[Identified Customers],A.[Customer's Name]
    having sum(sales) > 0
